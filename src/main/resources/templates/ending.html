<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏结局 - 命运分岔口</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        .ending-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 50px;
            margin: 50px auto;
            max-width: 800px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .ending-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
        }

        .ending-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .ending-content {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 30px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .score-display {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .btn-action {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            color: white;
        }

        .btn-secondary-action {
            background: linear-gradient(45deg, #6c757d, #495057);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .btn-secondary-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
            color: white;
        }

        .navbar-brand {
            font-weight: bold;
            color: #007bff !important;
        }

        .share-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-graduation-cap"></i> 命运分岔口
        </a>
        <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white me-3">
                    <i class="fas fa-user"></i> 欢迎，<span th:text="${user.nickname}">玩家</span>
                </span>
            <a class="nav-link" href="/">首页</a>
            <a class="nav-link" href="/game/history">我的记录</a>
            <a class="nav-link" href="/game/leaderboard">排行榜</a>
            <a class="nav-link" href="/auth/logout">退出</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="ending-container">
        <div class="ending-card">
            <h1 class="ending-title">
                <i class="fas fa-trophy"></i> 游戏结束
            </h1>

            <!-- 改用 th:utext 来显示 HTML <br/> 标签 -->
            <div class="ending-content" th:utext="${endingNode.content}">
                结局内容将在这里显示...
            </div>

            <div class="score-display" th:data-ending-type="${endingNode.endingType}"
                 th:data-final-score="${finalScore}">
                <h3><i class="fas fa-star"></i> 最终分数: <span th:text="${finalScore}">0</span></h3>
                <p>结局类型: <span th:text="${endingNode.endingType}">未知</span></p>
            </div>
        </div>

        <div class="share-section">
            <h4><i class="fas fa-share-alt"></i> 分享你的结局</h4>
            <p>你的选择创造了独特的校园生活故事！</p>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> 复制分享文本
                </button>
                <button type="button" class="btn btn-outline-success" onclick="shareToWeibo()">
                    <i class="fab fa-weibo"></i> 分享到微博
                </button>
            </div>
        </div>

        <div class="mt-4">
            <a href="/game/start" class="btn btn-action">
                <i class="fas fa-redo"></i> 重新开始游戏
            </a>
            <a href="/game/history" class="btn btn-secondary-action">
                <i class="fas fa-history"></i> 查看历史记录
            </a>
            <a href="/game/leaderboard" class="btn btn-secondary-action">
                <i class="fas fa-trophy"></i> 查看排行榜
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function copyToClipboard() {
        try {
            // 直接从显示的内容中提取分数和结局
            const scoreElement = document.querySelector('.score-display h3');
            const scoreText = scoreElement ? scoreElement.textContent : '0分';

            // 正确提取结局类型 - 从 <p> 标签中获取
            const endingElements = document.querySelectorAll('.score-display p');
            let endingType = '未知结局';

            if (endingElements.length > 0) {
                // 第二个 <p> 标签包含结局类型
                const endingP = endingElements[0];
                endingType = endingP.textContent.replace('结局类型: ', '').trim();
            }

            // 提取纯数字分数
            const finalScore = scoreText.match(/\d+/)?.[0] || '0';

            const text = `我在《命运分岔口》游戏中获得了"${endingType}"结局，最终分数：${finalScore}分！`;

            console.log('复制文本:', text); // 调试输出

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('✅ 分享文本已复制到剪贴板！');
                }).catch((err) => {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        } catch (error) {
            console.error('函数执行出错:', error);
            alert('❌ 复制失败，请重试');
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);

        try {
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');
            if (successful) {
                alert('✅ 分享文本已复制到剪贴板！');
            } else {
                alert('❌ 复制失败，请手动复制');
            }
        } catch (err) {
            console.error('备用复制失败:', err);
            alert('❌ 复制失败，请手动复制');
        } finally {
            document.body.removeChild(textArea);
        }
    }

    function shareToWeibo() {
        try {
            // 从 data 属性安全获取数据
            const scoreDisplay = document.querySelector('.score-display');
            const endingType = scoreDisplay?.getAttribute('data-ending-type') || '未知结局';
            const finalScore = scoreDisplay?.getAttribute('data-final-score') || '0';

            const text = `我在《命运分岔口》游戏中获得了"${endingType}"结局，最终分数：${finalScore}分！`;

            // 构建微博分享 URL
            const weiboUrl = new URL('https://service.weibo.com/share/share.php');
            weiboUrl.searchParams.append('url', window.location.origin);
            weiboUrl.searchParams.append('title', text);

            // 打开新窗口
            const popup = window.open(weiboUrl.toString(), '_blank', 'width=600,height=400');

            if (!popup) {
                alert('分享失败：请检查浏览器弹窗设置');
            }
        } catch (error) {
            console.error('分享到微博失败:', error);
            alert('分享失败，请稍后重试');
        }
    }
</script>
</body>
</html>
